#!/bin/bash
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ğŸš€ Fast Ollama LXC Setup v1.0         â•‘"
echo "â•‘  Optimized for Home Assistant          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

CTID=103
HOSTNAME="ollama-lxc"
ROOT_PASSWORD="ollama123"
RAM_GB=8
DISK_GB=20
TEMPLATE="debian-12-standard_12.12-1_amd64.tar.zst"

echo "ğŸ“¦ Installing Proxmox dependencies..."
apt update 2>/dev/null || true
apt install -y zstd curl wget 2>/dev/null || true

if [ ! -f "/var/lib/vz/template/cache/$TEMPLATE" ]; then
    echo "ğŸ“¥ Downloading Debian 12 template..."
    pveam download local $TEMPLATE
fi

echo "ğŸ“¦ Creating LXC container..."
pct create $CTID local:vztmpl/$TEMPLATE \
    --hostname $HOSTNAME \
    --password $ROOT_PASSWORD \
    --memory $((RAM_GB * 1024)) \
    --swap 2048 \
    --cores 4 \
    --rootfs local-lvm:$DISK_GB \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --features nesting=1 \
    --unprivileged 0 \
    --onboot 1

echo "ğŸ® Adding GPU passthrough..."
echo "" >> /etc/pve/lxc/${CTID}.conf
echo "# GPU Passthrough" >> /etc/pve/lxc/${CTID}.conf
echo "lxc.cgroup2.devices.allow: c 226:* rwm" >> /etc/pve/lxc/${CTID}.conf
echo "lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir" >> /etc/pve/lxc/${CTID}.conf

echo "â–¶ï¸  Starting container..."
pct start $CTID
sleep 10

echo "ğŸ”§ Installing system tools..."
pct exec $CTID -- bash -c "apt update && apt install -y curl zstd jq pciutils"

echo "ğŸ¤– Installing Ollama..."
pct exec $CTID -- bash -c "curl -fsSL https://ollama.com/install.sh | sh"

echo "âš™ï¸  Configuring Ollama..."
pct exec $CTID -- mkdir -p /etc/systemd/system/ollama.service.d
pct exec $CTID -- bash -c 'echo "[Service]" > /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- bash -c 'echo "Environment=\"OLLAMA_KEEP_ALIVE=24h\"" >> /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- bash -c 'echo "Environment=\"OLLAMA_HOST=0.0.0.0:11434\"" >> /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- bash -c 'echo "Environment=\"OLLAMA_VULKAN=1\"" >> /etc/systemd/system/ollama.service.d/override.conf'

pct exec $CTID -- systemctl daemon-reload
pct exec $CTID -- systemctl restart ollama
sleep 5

echo "ğŸ“¥ Downloading llama3.2:8b model..."
pct exec $CTID -- ollama pull llama3.2:8b

echo "ğŸ” Getting container IP..."
sleep 2
CTIP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

echo "ğŸ§ª Testing response time..."
pct exec $CTID -- bash -c 'time curl -s -X POST http://localhost:11434/v1/chat/completions -H "Content-Type: application/json" -d "{\"model\":\"llama3.2:3b\",\"messages\":[{\"role\":\"user\",\"content\":\"test\"}],\"stream\":false}" | jq -r ".choices[0].message.content"' 2>&1 | grep real

echo
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… Installation Complete!            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo
echo "ğŸ“‹ Container Details:"
echo "  Container ID:  $CTID"
echo "  Hostname:      $HOSTNAME"  
echo "  IP Address:    $CTIP"
echo "  Username:      root"
echo "  Password:      $ROOT_PASSWORD"
echo
echo "ğŸ”— Ollama API: http://$CTIP:11434"
echo
echo "ğŸ  For Home Assistant:"
echo "  URL: http://$CTIP:11434"
echo "  Model: llama3.2:3b"
echo
