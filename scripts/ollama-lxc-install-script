#!/bin/bash
set -e

# --- NASTAVENÃ BAREV ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # Bez barvy

# --- POMOCNÃ‰ FUNKCE ---
info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[POZOR]${NC} $1"; }
error() { echo -e "${RED}[CHYBA]${NC} $1"; }
ask() { echo -ne "${YELLOW}[DOTAZ]${NC} $1"; }

# --- ÃšVODNÃ OBRAZOVKA ---
clear
echo -e "${YELLOW}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${YELLOW}â•‘         ğŸ¤– CZ/SK OLLAMA LXC INSTALLER v1.5                â•‘${NC}"
echo -e "${YELLOW}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "Tento skript vytvoÅ™Ã­ kontejner pro provoz lokÃ¡lnÃ­ AI Ollama."
echo -e "Tip: Pro vÃ½chozÃ­ hodnotu staÄÃ­ stisknout ${GREEN}[ENTER]${NC}.\n"

# --- KONTROLA ROOT PRÃV ---
if [ "$(id -u)" -ne 0 ]; then
    error "Tento skript musÃ­ bÄ›Å¾et pod uÅ¾ivatelem root (v Shellu Proxmoxu)!"
    exit 1
fi

# --- INTERAKTIVNÃ DOTAZY ---

# 1. ID Kontejneru
NEXTID=$(pvesh get /cluster/nextid)
ask "Zadejte ID pro novÃ½ kontejner (vÃ½chozÃ­ $NEXTID): "
read input_id </dev/tty
CTID=${input_id:-$NEXTID}

# 2. ÃšloÅ¾iÅ¡tÄ›
STORAGE_AUTO=$(pvesm status -content rootdir | awk 'NR>1 {print $1}' | head -n 1)
ask "Na kterÃ© ÃºloÅ¾iÅ¡tÄ› instalovat? (vÃ½chozÃ­ $STORAGE_AUTO): "
read input_storage </dev/tty
STORAGE=${input_storage:-$STORAGE_AUTO}

# 3. RAM
ask "Kolik GB RAM pÅ™idÄ›lit? (doporuÄeno 8): "
read input_ram </dev/tty
RAM_GB=${input_ram:-8}

# 4. Disk
ask "Kolik GB mÃ­sta na disku? (doporuÄeno 20): "
read input_disk </dev/tty
DISK_GB=${input_disk:-20}

# --- SHRNUTÃ A POTVRZENÃ ---
echo -e "\n${GREEN}--- PLÃN INSTALACE ---${NC}"
echo -e "ID: $CTID | ÃšloÅ¾iÅ¡tÄ›: $STORAGE | RAM: ${RAM_GB}GB | Disk: ${DISK_GB}GB"
echo -e "${GREEN}----------------------${NC}\n"

# --- SAMOTNÃ INSTALACE ---
HOSTNAME="ollama-server"
ROOT_PASSWORD="ollama123"
TEMPLATE_NAME="debian-12-standard_12.12-1_amd64.tar.zst"

info "Aktualizuji repozitÃ¡Å™e Proxmoxu..."
apt update >/dev/null 2>&1 || true

info "Kontrola Å¡ablony Debian 12..."
if [ ! -f "/var/lib/vz/template/cache/$TEMPLATE_NAME" ]; then
    info "Stahuji Å¡ablonu Debian 12..."
    pveam download local $TEMPLATE_NAME
fi

info "VytvÃ¡Å™Ã­m LXC kontejner $CTID..."
pct create $CTID local:vztmpl/$TEMPLATE_NAME \
    --hostname $HOSTNAME \
    --password $ROOT_PASSWORD \
    --memory $((RAM_GB * 1024)) \
    --swap 2048 \
    --cores 4 \
    --rootfs ${STORAGE}:${DISK_GB} \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --features nesting=1 \
    --unprivileged 0 \
    --onboot 1

info "Startuji kontejner..."
pct start $CTID
sleep 10

info "Instaluji Ollama prostÅ™edÃ­ (mÅ¯Å¾e to chvÃ­li trvat)..."
pct exec $CTID -- bash -c "apt update && apt install -y curl jq zstd"
pct exec $CTID -- bash -c "curl -fsSL https://ollama.com/install.sh | sh"

info "Nastavuji sÃ­Å¥ovÃ½ pÅ™Ã­stup pro Home Assistanta..."
pct exec $CTID -- mkdir -p /etc/systemd/system/ollama.service.d
pct exec $CTID -- bash -c 'echo -e "[Service]\nEnvironment=\"OLLAMA_HOST=0.0.0.0:11434\"\nEnvironment=\"OLLAMA_KEEP_ALIVE=24h\"" > /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- systemctl daemon-reload
pct exec $CTID -- systemctl restart ollama

info "Stahuji zÃ¡kladnÃ­ model Gemma3:4b..."
pct exec $CTID -- ollama pull gemma3:4b

# --- ZÃVÄšR ---
CTIP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

echo -e "\n${GREEN}âœ… INSTALACE DOKONÄŒENA!${NC}"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo -e "ğŸ“ IP adresa:    ${YELLOW}$CTIP${NC}"
echo -e "ğŸ”‘ Root heslo:   ${YELLOW}$ROOT_PASSWORD${NC}"
echo -e "ğŸ’¬ SpuÅ¡tÄ›nÃ­ AI:  ${YELLOW}ssh root@$CTIP${NC} -> ${YELLOW}ollama run llama3.2:3b${NC}"
echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
