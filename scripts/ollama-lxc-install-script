#!/bin/bash
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸš€ Fast Ollama LXC Setup v1.1        â•‘"
echo "â•‘   Optimized for CZ/SK Community        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

CTID=103
HOSTNAME="ollama-lxc"
ROOT_PASSWORD="ollama123"
RAM_GB=8
DISK_GB=20
TEMPLATE="debian-12-standard_12.12-1_amd64.tar.zst"

# AutomatickÃ¡ detekce ÃºloÅ¾iÅ¡tÄ› (hledÃ¡ kde je povoleno uklÃ¡dat kontejnery)
STORAGE=$(pvesm status -content rootdir | awk 'NR>1 {print $1}' | head -n 1)
if [ -z "$STORAGE" ]; then
    STORAGE="local-lvm" # Fallback pokud detekce selÅ¾e
fi

echo "ğŸ“¦ Using storage: $STORAGE"

echo "ğŸ“¦ Installing Proxmox dependencies..."
apt update 2>/dev/null || true
apt install -y zstd curl wget 2>/dev/null || true

if [ ! -f "/var/lib/vz/template/cache/$TEMPLATE" ]; then
    echo "ğŸ“¥ Downloading Debian 12 template..."
    pveam download local $TEMPLATE
fi

echo "ğŸ“¦ Creating LXC container..."
# Pokud uÅ¾ kontejner existuje, skript se zastavÃ­ s chybou (bezpeÄnost)
if pct status $CTID >/dev/null 2>&1; then
    echo "âŒ Error: Container ID $CTID already exists!"
    exit 1
fi

pct create $CTID local:vztmpl/$TEMPLATE \
    --hostname $HOSTNAME \
    --password $ROOT_PASSWORD \
    --memory $((RAM_GB * 1024)) \
    --swap 2048 \
    --cores 4 \
    --rootfs ${STORAGE}:${DISK_GB} \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --features nesting=1 \
    --unprivileged 0 \
    --onboot 1

echo "â–¶ï¸ Starting container..."
pct start $CTID
sleep 10

echo "ğŸ”§ Installing system tools..."
pct exec $CTID -- bash -c "apt update && apt install -y curl zstd jq pciutils"

echo "ğŸ¤– Installing Ollama..."
pct exec $CTID -- bash -c "curl -fsSL https://ollama.com/install.sh | sh"

echo "âš™ï¸ Configuring Ollama..."
pct exec $CTID -- mkdir -p /etc/systemd/system/ollama.service.d
pct exec $CTID -- bash -c 'echo "[Service]" > /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- bash -c 'echo "Environment=\"OLLAMA_KEEP_ALIVE=24h\"" >> /etc/systemd/system/ollama.service.d/override.conf'
pct exec $CTID -- bash -c 'echo "Environment=\"OLLAMA_HOST=0.0.0.0:11434\"" >> /etc/systemd/system/ollama.service.d/override.conf'

pct exec $CTID -- systemctl daemon-reload
pct exec $CTID -- systemctl restart ollama
sleep 5

echo "ğŸ“¥ Downloading llama3.1:8b model..."
pct exec $CTID -- ollama pull llama3.1:8b

echo "ğŸ” Getting container IP..."
sleep 2
CTIP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

echo
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   âœ… Installation Complete!            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo
echo "ğŸ“‹ Container Details:"
echo "  Container ID:  $CTID"
echo "  IP Address:    $CTIP"
echo "  Password:      $ROOT_PASSWORD"
echo
echo "ğŸ’¬ To start chatting, connect via SSH and run:"
echo "  ollama run llama3.1:3b"
echo
echo
