#!/bin/bash
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸš€ Fast Ollama LXC Setup v1.2        â•‘"
echo "â•‘   Optimized for CZ/SK Community        â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo

# ============================================
# KONFIGURACE
# ============================================

HOSTNAME="ollama-lxc"
ROOT_PASSWORD="ollama123"
RAM_GB=8
DISK_GB=20
TEMPLATE="debian-12-standard_12.12-1_amd64.tar.zst"

# ============================================
# AUTO-DETEKCE VOLNÃ‰HO CTID
# ============================================

echo "ðŸ” HledÃ¡m volnÃ© Container ID..."
CTID=100
while pct status $CTID >/dev/null 2>&1; do
    CTID=$((CTID + 1))
    if [ $CTID -gt 999 ]; then
        echo "âŒ Error: No free Container ID found (100-999)!"
        exit 1
    fi
done
echo "âœ… Found free CTID: $CTID"

# ============================================
# AUTO-DETEKCE STORAGE
# ============================================

echo "ðŸ” Detecting storage..."
STORAGE=$(pvesm status -content rootdir | awk 'NR>1 {print $1}' | head -n 1)
if [ -z "$STORAGE" ]; then
    STORAGE="local-lvm"
fi
echo "âœ… Using storage: $STORAGE"

# ============================================
# INSTALACE DEPENDENCIES
# ============================================

echo
echo "ðŸ“¦ Installing Proxmox dependencies..."
apt update 2>/dev/null || true
apt install -y zstd curl wget 2>/dev/null || true

# ============================================
# STAÅ½ENÃ TEMPLATE
# ============================================

if [ ! -f "/var/lib/vz/template/cache/$TEMPLATE" ]; then
    echo "ðŸ“¥ Downloading Debian 12 template..."
    pveam download local $TEMPLATE
fi

# ============================================
# VYTVOÅ˜ENÃ LXC
# ============================================

echo
echo "ðŸ“¦ Creating LXC container..."
echo "  CTID:     $CTID"
echo "  Hostname: $HOSTNAME"
echo "  RAM:      ${RAM_GB}GB"
echo "  Disk:     ${DISK_GB}GB"
echo "  Storage:  $STORAGE"
echo

pct create $CTID local:vztmpl/$TEMPLATE \
    --hostname $HOSTNAME \
    --password $ROOT_PASSWORD \
    --memory $((RAM_GB * 1024)) \
    --swap 2048 \
    --cores 4 \
    --rootfs ${STORAGE}:${DISK_GB} \
    --net0 name=eth0,bridge=vmbr0,ip=dhcp \
    --features nesting=1 \
    --unprivileged 0 \
    --onboot 1

echo "â–¶ï¸ Starting container..."
pct start $CTID
sleep 10

# ============================================
# INSTALACE V KONTEJNERU
# ============================================

echo "ðŸ”§ Installing system tools..."
pct exec $CTID -- bash -c "apt update && apt install -y curl zstd jq pciutils"

echo "ðŸ¤– Installing Ollama..."
pct exec $CTID -- bash -c "curl -fsSL https://ollama.com/install.sh | sh"

echo "âš™ï¸ Configuring Ollama..."
pct exec $CTID -- mkdir -p /etc/systemd/system/ollama.service.d
pct exec $CTID -- bash -c 'cat > /etc/systemd/system/ollama.service.d/override.conf <<EOF
[Service]
Environment="OLLAMA_KEEP_ALIVE=24h"
Environment="OLLAMA_HOST=0.0.0.0:11434"
EOF'

pct exec $CTID -- systemctl daemon-reload
pct exec $CTID -- systemctl restart ollama
sleep 5

# ============================================
# STAÅ½ENÃ MODELU
# ============================================

echo
echo "ðŸ“¥ Downloading llama3.1:8b model..."
echo "â³ This may take several minutes..."
pct exec $CTID -- ollama pull llama3.1:8b
echo "âœ… Model downloaded successfully"

# ============================================
# ZÃSKÃNÃ IP ADRESY
# ============================================

echo
echo "ðŸ” Getting container IP..."
sleep 2
CTIP=$(pct exec $CTID -- hostname -I | awk '{print $1}')

# ============================================
# ZÃVÄšR
# ============================================

echo
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   âœ… Installation Complete!            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo
echo "ðŸ“‹ Container Details:"
echo "  Container ID:  $CTID"
echo "  Hostname:      $HOSTNAME"
echo "  IP Address:    $CTIP"
echo "  Password:      $ROOT_PASSWORD"
echo "  Model:         llama3.1:8b"
echo
echo "ðŸŒ Ollama API Endpoint:"
echo "  http://$CTIP:11434"
echo
echo "ðŸ’¬ To start chatting:"
echo "  1. Connect via SSH: ssh root@$CTIP"
echo "  2. Run: ollama run llama3.1:8b"
echo
echo "ðŸ”§ To access container shell from Proxmox:"
echo "  pct enter $CTID"
echo
echo "ðŸ“š Model Management:"
echo "  List models:    ollama list"
echo "  Delete model:   ollama rm llama3.1:8b"
echo "  Download model: ollama pull llama3.2:3b"
echo
